name: "Deploy Application"
description: "Unified deployment action for all environments"

inputs:
  environment:
    description: "Target environment (staging|production)"
    required: true
  image_tag:
    description: "Docker image tag to deploy"
    required: true
  skip_tests:
    description: "Skip post-deployment tests"
    required: false
    default: "false"

outputs:
  deployment_status:
    description: "Deployment result (success|failed)"
    value: ${{ steps.final-result.outputs.status }}
  deployed_url:
    description: "URL where application was deployed"
    value: ${{ steps.final-result.outputs.url }}

runs:
  using: "composite"
  steps:
    - name: Setup deployment environment
      shell: bash
      run: |
        echo "ðŸš€ Starting deployment to ${{ inputs.environment }}"
        echo "ðŸ“¦ Image: ${{ inputs.image_tag }}"
        echo "â° $(date)"

        # Set deployment environment variables
        echo "DEPLOY_ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV
        echo "DOCKER_IMAGE=${{ inputs.image_tag }}" >> $GITHUB_ENV

    - name: Setup infrastructure
      shell: bash
      run: |
        echo "ðŸ”§ Setting up infrastructure for ${{ inputs.environment }}..."

        # This would normally call Terraform/Ansible
        # For now, we'll simulate infrastructure setup
        echo "âœ… Infrastructure setup completed"

    - name: Deploy application
      shell: bash
      run: |
        echo "ðŸ“¦ Deploying application with image: ${{ inputs.image_tag }}"

        # This would normally run Ansible playbooks or Docker deployments
        # For now, we'll simulate deployment
        echo "âœ… Application deployment completed"

    - name: Run post-deployment tests
      if: inputs.skip_tests != 'true'
      uses: ./.github/actions/test-runner
      with:
        test_type: smoke
        environment: ${{ inputs.environment }}
        app_url: ${{ vars.APP_URL }}
        fail_fast: false
        timeout_minutes: 5

    - name: Verify deployment
      id: verify
      shell: bash
      run: |
        echo "ðŸ” Verifying deployment..."

        # Basic deployment verification
        DEPLOYMENT_SUCCESS=true

        # Check if deployment artifacts exist
        if [ -f "deployment.log" ]; then
          echo "âœ… Deployment log found"
        else
          echo "âš ï¸ Deployment log not found"
        fi

        echo "verification_success=$DEPLOYMENT_SUCCESS" >> $GITHUB_OUTPUT

    - name: Generate deployment summary
      id: final-result
      shell: bash
      run: |
        echo "ðŸ“‹ Generating deployment summary..."

        # Determine deployment status
        if [ "${{ steps.verify.outputs.verification_success }}" = "true" ]; then
          DEPLOYMENT_STATUS="success"
          echo "ðŸŽ‰ Deployment completed successfully"
        else
          DEPLOYMENT_STATUS="failed"
          echo "âŒ Deployment verification failed"
        fi

        # Get deployment URL based on environment
        case "${{ inputs.environment }}" in
          "production")
            DEPLOY_URL="https://boximity.ca"
            ;;
          "staging")
            DEPLOY_URL="https://staging.boximity.ca"
            ;;
          *)
            DEPLOY_URL="unknown"
            ;;
        esac

        echo "status=$DEPLOYMENT_STATUS" >> $GITHUB_OUTPUT
        echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT

        echo "ðŸ“Š Deployment Summary:"
        echo "  Environment: ${{ inputs.environment }}"
        echo "  Status: $DEPLOYMENT_STATUS"
        echo "  URL: $DEPLOY_URL"
        echo "  Image: ${{ inputs.image_tag }}"
        echo "  Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

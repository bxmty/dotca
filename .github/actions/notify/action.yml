name: "Send GitHub Notifications"
description: "Send deployment notifications to GitHub"

inputs:
  event_type:
    description: "Type of event (deployment-success, deployment-failed, etc.)"
    required: true
  environment:
    description: "Target environment"
    required: true
  workflow_run_id:
    description: "GitHub workflow run ID"
    required: false
  commit:
    description: "Git commit SHA"
    required: false
  triggered_by:
    description: "User who triggered the deployment"
    required: false
  deployment_details:
    description: "JSON string with deployment details"
    required: false

runs:
  using: "composite"
  steps:
    - name: Prepare notification data
      shell: bash
      run: |
        echo "ðŸ“¢ Preparing notification for ${{ inputs.event_type }}"

        # Parse deployment details if provided
        if [ -n "${{ inputs.deployment_details }}" ]; then
          echo "Deployment details provided"
        fi

        # Create notification payload (single line for GITHUB_ENV)
        NOTIFICATION_DATA="{\"event_type\":\"${{ inputs.event_type }}\",\"environment\":\"${{ inputs.environment }}\",\"workflow_run_id\":\"${{ inputs.workflow_run_id }}\",\"commit\":\"${{ inputs.commit }}\",\"triggered_by\":\"${{ inputs.triggered_by }}\",\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"repository\":\"${{ github.repository }}\",\"run_url\":\"https://github.com/${{ github.repository }}/actions/runs/${{ inputs.workflow_run_id }}\"}"

        echo "NOTIFICATION_DATA=$NOTIFICATION_DATA" >> $GITHUB_ENV

    - name: Send GitHub notification
      shell: bash
      run: |
        echo "ðŸ“ Sending GitHub notification..."

        # Determine emoji and message based on event type
        case "${{ inputs.event_type }}" in
          "deployment-success")
            EMOJI="âœ…"
            TITLE="Deployment Successful"
            COLOR="good"
            ;;
          "deployment-failed")
            EMOJI="âŒ"
            TITLE="Deployment Failed"
            COLOR="danger"
            ;;
          *)
            EMOJI="â„¹ï¸"
            TITLE="Deployment Update"
            COLOR="warning"
            ;;
        esac

        # Create GitHub step summary
        echo "## $EMOJI $TITLE" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Event:** ${{ inputs.event_type }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ inputs.commit }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** ${{ inputs.triggered_by }}" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** [${{ inputs.workflow_run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ inputs.workflow_run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY

        echo "âœ… GitHub notification sent"


    - name: Log notification event
      shell: bash
      run: |
        echo "ðŸ“‹ Notification Summary:"
        echo "  Event: ${{ inputs.event_type }}"
        echo "  Environment: ${{ inputs.environment }}"
        echo "  Workflow: ${{ inputs.workflow_run_id }}"
        echo "  Commit: ${{ inputs.commit }}"
        echo "  Triggered by: ${{ inputs.triggered_by }}"
        echo "  Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        echo "âœ… GitHub notifications sent"

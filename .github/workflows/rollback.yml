name: Deployment Rollback

# This workflow handles emergency rollback of failed deployments
# Can be triggered manually or automatically based on health check failures

on:
  # Manual rollback trigger
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to rollback (staging, production)"
        required: true
        type: choice
        options: [staging, production]
        default: "staging"
      reason:
        description: "Reason for rollback"
        required: false
        default: "Manual rollback request"
        type: string
      force_rollback:
        description: "Force rollback even if safety checks fail"
        required: false
        default: false
        type: boolean

  # Automatic rollback trigger (when deployment fails)
  workflow_call:
    inputs:
      environment:
        description: "Environment that failed"
        required: true
        type: string
      failed_workflow_run_id:
        description: "ID of the failed workflow run"
        required: true
        type: string
      failure_reason:
        description: "Reason for failure"
        required: false
        type: string
    secrets:
      DO_TOKEN:
        required: true
      SSH_PRIVATE_KEY:
        required: true
      SSH_KEY_FINGERPRINT:
        required: true
      SPACES_ACCESS_ID:
        required: true
      SPACES_SECRET_KEY:
        required: true
      ANSIBLE_VAULT_PASSWORD:
        required: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Safety checks before rollback
  rollback-safety-check:
    name: Rollback Safety Check
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || github.event.inputs.environment }}
    outputs:
      rollback_safe: ${{ steps.safety.outputs.safe }}
      last_stable_image: ${{ steps.safety.outputs.last_stable_image }}
      rollback_reason: ${{ steps.safety.outputs.rollback_reason }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Perform rollback safety checks
        id: safety
        shell: bash
        run: |
          ENVIRONMENT="${{ inputs.environment || github.event.inputs.environment }}"
          echo "ðŸ” Performing rollback safety checks for $ENVIRONMENT environment..."

          # Determine rollback reason
          if [ -n "${{ github.event.inputs.reason }}" ]; then
            ROLLBACK_REASON="${{ github.event.inputs.reason }}"
          elif [ -n "${{ inputs.failure_reason }}" ]; then
            ROLLBACK_REASON="${{ inputs.failure_reason }}"
          else
            ROLLBACK_REASON="Emergency rollback"
          fi

          echo "rollback_reason=$ROLLBACK_REASON" >> $GITHUB_OUTPUT

          # Check if we have deployment history
          DEPLOYMENT_LOG="deployment-${ENVIRONMENT}.log"
          if [ -f "$DEPLOYMENT_LOG" ]; then
            echo "âœ… Deployment history found"
            LAST_DEPLOYMENT=$(tail -1 "$DEPLOYMENT_LOG" | jq -r '.image_tag // empty' 2>/dev/null || echo "")
            if [ -n "$LAST_DEPLOYMENT" ]; then
              echo "Last deployment: $LAST_DEPLOYMENT"
            fi
          else
            echo "âš ï¸ No deployment history found"
          fi

          # Find last stable image tag
          # This would typically query a registry or database
          # For now, we'll use a fallback approach
          case "$ENVIRONMENT" in
            "production")
              # For production, look for the previous stable tag
              LAST_STABLE="main-previous"  # This would be dynamic in real implementation
              ;;
            "staging")
              # For staging, use the last known good deployment
              LAST_STABLE="staging-last-stable"  # This would be dynamic in real implementation
              ;;
            *)
              LAST_STABLE="unknown"
              ;;
          esac

          echo "last_stable_image=$LAST_STABLE" >> $GITHUB_OUTPUT

          # Safety checks
          SAFETY_ISSUES=0

          # Check if rollback is allowed for this environment
          if [ "$ENVIRONMENT" = "production" ]; then
            # Additional safety checks for production
            if [ "${{ github.event.inputs.force_rollback }}" != "true" ] && [ -z "${{ inputs.failed_workflow_run_id }}" ]; then
              echo "âŒ Production rollback requires either force flag or failed workflow trigger"
              SAFETY_ISSUES=$((SAFETY_ISSUES + 1))
            fi
          fi

          # Check if stable image exists
          if [ "$LAST_STABLE" = "unknown" ]; then
            echo "âš ï¸ Could not determine last stable image"
            SAFETY_ISSUES=$((SAFETY_ISSUES + 1))
          fi

          # Determine if rollback is safe
          if [ $SAFETY_ISSUES -eq 0 ]; then
            echo "âœ… Rollback safety checks PASSED"
            echo "safe=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Rollback safety checks FAILED ($SAFETY_ISSUES issues)"
            if [ "${{ github.event.inputs.force_rollback }}" = "true" ]; then
              echo "âš ï¸ Force rollback enabled - proceeding despite safety issues"
              echo "safe=true" >> $GITHUB_OUTPUT
            else
              echo "safe=false" >> $GITHUB_OUTPUT
            fi
          fi

          echo "ðŸ“‹ Safety Check Summary:"
          echo "  Environment: $ENVIRONMENT"
          echo "  Rollback Reason: $ROLLBACK_REASON"
          echo "  Last Stable Image: $LAST_STABLE"
          echo "  Safety Issues: $SAFETY_ISSUES"

  # Execute the rollback
  execute-rollback:
    name: Execute Rollback
    runs-on: ubuntu-latest
    needs: [rollback-safety-check]
    if: needs.rollback-safety-check.outputs.rollback_safe == 'true'
    environment: ${{ inputs.environment || github.event.inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup rollback environment
        shell: bash
        run: |
          ENVIRONMENT="${{ inputs.environment || github.event.inputs.environment }}"
          STABLE_IMAGE="${{ needs.rollback-safety-check.outputs.last_stable_image }}"
          ROLLBACK_REASON="${{ needs.rollback-safety-check.outputs.rollback_reason }}"

          echo "ðŸ”„ Starting rollback for $ENVIRONMENT environment"
          echo "ðŸ“¦ Target Image: $STABLE_IMAGE"
          echo "ðŸ“ Reason: $ROLLBACK_REASON"
          echo "â° $(date)"

          # Set environment variables for rollback
          echo "ROLLBACK_ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
          echo "ROLLBACK_IMAGE=$STABLE_IMAGE" >> $GITHUB_ENV
          echo "ROLLBACK_REASON=$ROLLBACK_REASON" >> $GITHUB_ENV

      - name: Execute rollback deployment
        uses: ./.github/actions/deploy
        id: rollback-deployment
        with:
          environment: ${{ inputs.environment || github.event.inputs.environment }}
          image_tag: ${{ needs.rollback-safety-check.outputs.last_stable_image }}
          skip_tests: false # Always run tests during rollback
        env:
          DO_TOKEN: ${{ secrets.DO_TOKEN }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KEY_FINGERPRINT: ${{ secrets.SSH_KEY_FINGERPRINT }}
          SPACES_ACCESS_ID: ${{ secrets.SPACES_ACCESS_ID }}
          SPACES_SECRET_KEY: ${{ secrets.SPACES_SECRET_KEY }}
          BREVO_API_KEY: ${{ secrets.BREVO_API_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_PRODUCTION_GA_ID: ${{ secrets.NEXT_PUBLIC_PRODUCTION_GA_ID }}
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update stable image reference
        if: steps.rollback-deployment.outcome == 'success'
        shell: bash
        run: |
          echo "ðŸ“ Updating stable image reference..."
          # This would update a database or registry with the new stable image
          echo "âœ… Stable image reference updated"

      - name: Log rollback completion
        shell: bash
        run: |
          echo "ðŸ“‹ Rollback Summary:"
          echo "  Environment: ${{ inputs.environment || github.event.inputs.environment }}"
          echo "  Previous Image: ${{ needs.rollback-safety-check.outputs.last_stable_image }}"
          echo "  Status: ${{ steps.rollback-deployment.outcome == 'success' && 'SUCCESS' || 'FAILED' }}"
          echo "  Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "  Reason: ${{ needs.rollback-safety-check.outputs.rollback_reason }}"

  # Send rollback notifications
  rollback-notifications:
    name: Rollback Notifications
    runs-on: ubuntu-latest
    needs: [rollback-safety-check, execute-rollback]
    if: always() # Always send notifications

    steps:
      - name: Send rollback notifications
        uses: ./.github/actions/notify
        with:
          event_type: ${{ needs.execute-rollback.result == 'success' && 'rollback-success' || 'rollback-failed' }}
          environment: ${{ inputs.environment || github.event.inputs.environment }}
          workflow_run_id: ${{ github.run_id }}
          commit: ${{ github.sha }}
          triggered_by: ${{ github.actor }}
          deployment_details: |
            {
              "rollback_image": "${{ needs.rollback-safety-check.outputs.last_stable_image }}",
              "rollback_reason": "${{ needs.rollback-safety-check.outputs.rollback_reason }}",
              "safety_checks_passed": "${{ needs.rollback-safety-check.outputs.rollback_safe }}",
              "rollback_success": "${{ needs.execute-rollback.result == 'success' }}",
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "trigger_type": "${{ github.event_name }}"
            }
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          TEAMS_WEBHOOK: ${{ secrets.TEAMS_WEBHOOK }}

  # Generate rollback report
  rollback-report:
    name: Rollback Report
    runs-on: ubuntu-latest
    needs: [rollback-safety-check, execute-rollback, rollback-notifications]
    if: always()

    steps:
      - name: Generate rollback summary
        shell: bash
        run: |
          ENVIRONMENT="${{ inputs.environment || github.event.inputs.environment }}"
          SUCCESS="${{ needs.execute-rollback.result == 'success' }}"
          STABLE_IMAGE="${{ needs.rollback-safety-check.outputs.last_stable_image }}"
          ROLLBACK_REASON="${{ needs.rollback-safety-check.outputs.rollback_reason }}"

          echo "## ðŸ”„ Rollback Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ SUCCESS == 'true' && 'âœ… SUCCESS' || 'âŒ FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback Image:** $STABLE_IMAGE" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** $ROLLBACK_REASON" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Rollback Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Safety Checks:** ${{ needs.rollback-safety-check.outputs.rollback_safe == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment:** ${{ needs.execute-rollback.result == 'success' && 'âœ… SUCCESS' || 'âŒ FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Notifications:** ${{ needs.rollback-notifications.result == 'success' && 'âœ… SENT' || 'âŒ FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$SUCCESS" = "true" ]; then
            echo "### âœ… Rollback Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "The $ENVIRONMENT environment has been rolled back to a stable state." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Rollback Issues Detected" >> $GITHUB_STEP_SUMMARY
            echo "Please review the workflow logs and take manual corrective action if needed." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [\`$GITHUB_RUN_ID\`]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" >> $GITHUB_STEP_SUMMARY

version: '3'

services:
  # Define web service (for staging) and alias it as app (for production)
  web:
    image: "{{ docker_image }}"
    pull_policy: always
    restart: always
    ports:
      - "8080:3000"
    environment:
      - NODE_ENV={{ node_env | default('production') }}
      - NEXT_PUBLIC_API_URL={{ next_public_api_url }}
      - NEXT_PUBLIC_ENVIRONMENT={{ next_public_environment | default('production') }}
      - STRIPE_SECRET_KEY={{ stripe_secret_key }}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY={{ stripe_publishable_key }}
      - BREVO_API_KEY={{ brevo_api_key }}
      - NEXT_PUBLIC_STAGING_GA_ID={{ ga_staging_id | default('') }}
      - NEXT_PUBLIC_PRODUCTION_GA_ID={{ ga_production_id | default('') }}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    volumes:
      - next_cache:/app/.next/cache
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  
  # Create an alias for the web service to handle "app" references in production
  app:
    extends: web

# Define volumes for persistent data
volumes:
  next_cache:

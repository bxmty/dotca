#!/bin/bash

# Umami Database Backup Script
# This script performs automated backups of the Umami PostgreSQL database

LOG_FILE="{{ app_dir }}/monitoring.log"

# Function to log messages with timestamps
log_message() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Database backup configuration
BACKUP_DIR="{{ app_dir }}/backups"
DB_CONTAINER="umami-db"
DB_NAME="umami"
DB_USER="umami"
RETENTION_DAYS=7

log_message "=== Starting Umami Database Backup ==="

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Generate timestamp for backup file
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$BACKUP_DIR/umami_backup_$TIMESTAMP.sql"

# Check if Umami database container is running
if ! docker ps | grep -q "$DB_CONTAINER"; then
  log_message "ERROR: Umami database container ($DB_CONTAINER) is not running. Skipping backup."
  exit 1
fi

log_message "Performing Umami database backup..."

# Perform database backup using pg_dump
if docker exec "$DB_CONTAINER" pg_dump -U "$DB_USER" -d "$DB_NAME" > "$BACKUP_FILE" 2>/dev/null; then
  # Compress the backup file
  gzip "$BACKUP_FILE"
  COMPRESSED_FILE="$BACKUP_FILE.gz"

  # Get backup file size
  BACKUP_SIZE=$(du -h "$COMPRESSED_FILE" | cut -f1)

  log_message "SUCCESS: Umami database backup completed - $COMPRESSED_FILE ($BACKUP_SIZE)"

  # Clean up old backups (keep only last RETENTION_DAYS days)
  log_message "Cleaning up backups older than $RETENTION_DAYS days..."
  find "$BACKUP_DIR" -name "umami_backup_*.sql.gz" -mtime +$RETENTION_DAYS -delete
  CLEANED_COUNT=$?
  if [ $CLEANED_COUNT -gt 0 ]; then
    log_message "Cleaned up old backup files"
  fi

  # List current backups for reference
  BACKUP_COUNT=$(find "$BACKUP_DIR" -name "umami_backup_*.sql.gz" | wc -l)
  log_message "Total Umami backups retained: $BACKUP_COUNT"

  log_message "=== Umami Database Backup Completed Successfully ==="
  exit 0
else
  log_message "ERROR: Failed to backup Umami database"
  # Clean up failed backup file
  rm -f "$BACKUP_FILE"
  log_message "=== Umami Database Backup Failed ==="
  exit 1
fi

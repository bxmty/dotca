#!/bin/bash

# Enhanced monitoring script with reliable docker-compose usage and Umami analytics support
LOG_FILE="{{ app_dir }}/monitoring.log"

# Function to log messages
log_message() {
  echo "[$(date)] $1" | tee -a $LOG_FILE
}

# Function to backup Umami database
backup_umami_database() {
  log_message "Starting Umami database backup..."

  # Create backup directory if it doesn't exist
  mkdir -p "$BACKUP_DIR"

  # Generate timestamp for backup file
  TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
  BACKUP_FILE="$BACKUP_DIR/umami_backup_$TIMESTAMP.sql"

  # Check if Umami database container is running
  if ! docker ps | grep -q "$DB_CONTAINER"; then
    log_message "ERROR: Umami database container ($DB_CONTAINER) is not running. Skipping backup."
    return 1
  fi

  # Perform database backup using pg_dump
  if docker exec "$DB_CONTAINER" pg_dump -U "$DB_USER" -d "$DB_NAME" > "$BACKUP_FILE" 2>/dev/null; then
    # Compress the backup file
    gzip "$BACKUP_FILE"
    COMPRESSED_FILE="$BACKUP_FILE.gz"

    # Get backup file size
    BACKUP_SIZE=$(du -h "$COMPRESSED_FILE" | cut -f1)

    log_message "SUCCESS: Umami database backup completed - $COMPRESSED_FILE ($BACKUP_SIZE)"

    # Clean up old backups (keep only last RETENTION_DAYS days)
    log_message "Cleaning up backups older than $RETENTION_DAYS days..."
    find "$BACKUP_DIR" -name "umami_backup_*.sql.gz" -mtime +$RETENTION_DAYS -delete
    CLEANED_COUNT=$?
    if [ $CLEANED_COUNT -gt 0 ]; then
      log_message "Cleaned up old backup files"
    fi

    return 0
  else
    log_message "ERROR: Failed to backup Umami database"
    # Clean up failed backup file
    rm -f "$BACKUP_FILE"
    return 1
  fi
}

# Function to check Umami service health
check_umami_health() {
  log_message "Checking Umami service health..."

  # Check if Umami container is running
  if ! docker ps | grep -q "umami-app"; then
    log_message "ERROR: Umami application container is not running"
    return 1
  fi

  # Check Umami database connectivity
  if ! docker ps | grep -q "$DB_CONTAINER"; then
    log_message "ERROR: Umami database container is not running"
    return 1
  fi

  # Test database connectivity via container
  if ! docker exec "$DB_CONTAINER" pg_isready -U "$DB_USER" -d "$DB_NAME" >/dev/null 2>&1; then
    log_message "ERROR: Cannot connect to Umami database"
    return 1
  fi

  # Check Umami application health endpoint
  if ! curl -s -f -m 10 "$UMAMI_HEALTH_URL" >/dev/null 2>&1; then
    log_message "ERROR: Umami application health check failed"
    return 1
  fi

  log_message "SUCCESS: Umami service is healthy"
  return 0
}

# Application health check
HEALTH_CHECK_URL="http://localhost/health"
UMAMI_HEALTH_URL="http://localhost:3001/api/health"

# Database backup configuration
BACKUP_DIR="{{ app_dir }}/backups"
DB_CONTAINER="umami-db"
DB_NAME="umami"
DB_USER="umami"
RETENTION_DAYS=7

# Check if manual backup is requested
FORCE_BACKUP=false
if [ "$1" = "backup" ]; then
  FORCE_BACKUP=true
fi

log_message "Starting health check..."

# Check if Docker is running
if ! systemctl is-active --quiet docker; then
  log_message "Docker service is not running! Attempting to restart..."
  systemctl restart docker
  sleep 10
fi

# Check available disk space
DISK_SPACE=$(df -h /tmp | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$DISK_SPACE" -gt 90 ]; then
  log_message "Disk space low ($DISK_SPACE%). Cleaning up Docker..."
  docker system prune -af --volumes
fi

# Check Docker container status
cd {{ app_dir }}/repo
if ! docker ps | grep -q "{{ project_name }}.*web"; then
  log_message "Web container not running properly! Attempting to restart..."
  docker-compose down web
  docker-compose up -d db umami web
  sleep 15
fi

# Check Umami service health
if ! check_umami_health; then
  log_message "Umami service unhealthy. Attempting to restart Umami services..."
  cd {{ app_dir }}/repo
  # Restart only Umami services to avoid disrupting main application
  docker-compose restart db umami
  sleep 10

  # Re-check Umami health after restart
  if ! check_umami_health; then
    log_message "WARNING: Umami service still unhealthy after restart"
  fi
fi

# Restart application services if needed
if ! curl -s -f -o /dev/null -w "%{http_code}" $HEALTH_CHECK_URL | grep -q "200"; then
  log_message "Application not responding. Restarting services..."
  cd {{ app_dir }}/repo
  docker-compose down --remove-orphans && docker-compose up -d db umami web
  sleep 5
  systemctl restart nginx
fi

# Perform Umami database backup (daily at midnight, or if forced)
CURRENT_HOUR=$(date +"%H")
CURRENT_MIN=$(date +"%M")
if [ "$FORCE_BACKUP" = "true" ] || ([ "$CURRENT_HOUR" = "00" ] && [ "$CURRENT_MIN" -lt "15" ]); then
  if [ "$FORCE_BACKUP" = "true" ]; then
    log_message "Running manual Umami database backup..."
  else
    log_message "Running scheduled daily Umami database backup..."
  fi
  backup_umami_database
fi

# Final health status summary
MAIN_APP_HEALTHY=false
UMAMI_HEALTHY=false

if curl -s -f -o /dev/null -w "%{http_code}" $HEALTH_CHECK_URL | grep -q "200"; then
  MAIN_APP_HEALTHY=true
fi

if check_umami_health >/dev/null 2>&1; then
  UMAMI_HEALTHY=true
fi

if [ "$MAIN_APP_HEALTHY" = "true" ] && [ "$UMAMI_HEALTHY" = "true" ]; then
  log_message "SUCCESS: All services healthy (Main application + Umami analytics)"
elif [ "$MAIN_APP_HEALTHY" = "true" ] && [ "$UMAMI_HEALTHY" = "false" ]; then
  log_message "WARNING: Main application healthy, but Umami analytics service unhealthy"
elif [ "$MAIN_APP_HEALTHY" = "false" ] && [ "$UMAMI_HEALTHY" = "true" ]; then
  log_message "WARNING: Umami analytics healthy, but main application unhealthy"
else
  log_message "CRITICAL: Both main application and Umami analytics services unhealthy. Manual intervention required!"
fi

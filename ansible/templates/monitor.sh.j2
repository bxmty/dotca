#!/bin/bash

# Enhanced monitoring script for Next.js application
LOG_FILE="{{ app_dir }}/monitoring.log"

# Function to log messages
log_message() {
  echo "[$(date)] $1" | tee -a $LOG_FILE
}

# Application health check
HEALTH_CHECK_URL="http://localhost/health"

# Check if manual backup is requested
FORCE_BACKUP=false
if [ "$1" = "backup" ]; then
  FORCE_BACKUP=true
fi

log_message "Starting health check..."

# Check if Docker is running
if ! systemctl is-active --quiet docker; then
  log_message "Docker service is not running! Attempting to restart..."
  systemctl restart docker
  sleep 10
fi

# Check available disk space
DISK_SPACE=$(df -h /tmp | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$DISK_SPACE" -gt 90 ]; then
  log_message "Disk space low ($DISK_SPACE%). Cleaning up Docker..."
  docker system prune -af --volumes
fi

# Check Docker container status
cd {{ app_dir }}/repo
if ! docker ps | grep -q "{{ project_name }}.*web"; then
  log_message "Web container not running properly! Attempting to restart..."
  docker-compose down web
  docker-compose up -d web
  sleep 15
fi

# Restart application services if needed
if ! curl -s -f -o /dev/null -w "%{http_code}" $HEALTH_CHECK_URL | grep -q "200"; then
  log_message "Application not responding. Restarting services..."
  cd {{ app_dir }}/repo
  docker-compose down --remove-orphans && docker-compose up -d web
  sleep 5
  systemctl restart nginx
fi

# Final health status summary
if curl -s -f -o /dev/null -w "%{http_code}" $HEALTH_CHECK_URL | grep -q "200"; then
  log_message "SUCCESS: Application is healthy"
else
  log_message "CRITICAL: Application is unhealthy. Manual intervention required!"
fi

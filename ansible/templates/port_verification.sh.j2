#!/bin/bash
echo "=== Final port 3000 verification ==="

# Check for any remaining Docker containers
echo "Checking for any remaining Docker containers..."
REMAINING=$(docker ps --format '{% raw %}{{.Names}}\t{{.Ports}}{% endraw %}' | grep ':3000' || true)
if [ ! -z "$REMAINING" ]; then
  echo "ERROR: Found Docker containers still using port 3000:"
  echo "$REMAINING"
  echo "Force stopping them..."
  docker ps --format '{% raw %}{{.ID}}{% endraw %}' | xargs -r docker inspect --format='{% raw %}{{.Id}} {{.NetworkSettings.Ports}}{% endraw %}' | grep '3000' | cut -d' ' -f1 | xargs -r docker stop || true
fi

# Check system level port usage
if command -v netstat >/dev/null; then
  if netstat -tlnp 2>/dev/null | grep ":3000 "; then
    echo "ERROR: Port 3000 is still in use by system process:"
    netstat -tlnp | grep ":3000" || true
    echo "Attempting to kill processes using port 3000..."
    lsof -ti:3000 | xargs -r kill -9 || true
    sleep 5
    # Re-check after killing
    if netstat -tlnp 2>/dev/null | grep ":3000 "; then
      echo "CRITICAL: Port 3000 still in use after cleanup attempts"
      netstat -tlnp | grep ":3000" || true
      exit 1
    else
      echo "SUCCESS: Port 3000 freed after process cleanup"
    fi
  else
    echo "SUCCESS: Port 3000 is free (netstat)"
  fi
elif command -v ss >/dev/null; then
  if ss -tlnp | grep ":3000 "; then
    echo "ERROR: Port 3000 is still in use:"
    ss -tlnp | grep ":3000" || true
    exit 1
  else
    echo "SUCCESS: Port 3000 is free (ss)"
  fi
else
  echo "WARNING: Cannot verify port status (netstat/ss not available)"
fi

echo "=== Port verification completed ==="
